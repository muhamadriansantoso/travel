/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import * as utils from './ng-wizard.utils';
import { NoChildRoutes, NoWizardRoute, NoWsInterface } from './ng-wizard-error/ng-wizard.error';
import { BehaviorSubject } from 'rxjs';
import { map } from 'rxjs/operators';
export class NgWizardService {
    /**
     * @param {?} router
     */
    constructor(router) {
        this.router = router;
        this.stepData = [];
        this.stepDataChanges = new BehaviorSubject([]);
    }
    /**
     * Initializes the wizard by parsing the wizard's child routes found in Angular's router config
     * into a list of NgWizardStepData.
     * @param {?} wizardComponentName The name of the wizard component
     * @return {?}
     */
    loadWizardRoutes(wizardComponentName) {
        this.wizardRoute = this.getWizardRoute(wizardComponentName);
        if (!this.wizardRoute) {
            throw new NoWizardRoute(wizardComponentName);
        }
        this.wizardOptions = utils.mergeWizardOptions(this.wizardRoute.data);
        this.loadChildRoutes(this.wizardRoute);
    }
    /**
     * Checks and stores the currently displayed component.
     * @param {?} componentRef A reference to the currently displayed component
     * @return {?}
     */
    registerActiveComponent(componentRef) {
        if (!utils.componentImplementsNgWizardStepInterface(componentRef)) {
            throw new NoWsInterface(componentRef.constructor.name);
        }
        // Cast to unknown before casting to NgWizardStep to let typescript know we checked and approve
        // this conversion.
        this.currentComponent = (/** @type {?} */ (((/** @type {?} */ (componentRef)))));
        this.currentStepData = utils.getStepDataForUrl(this.stepData, this.router.url);
        this.currentStepData.componentRef = componentRef;
        this.resetCurrentStep();
        this.currentStepData.isCurrent = true;
        this.onStepDataChange();
    }
    /**
     * Calls the current component's wsOnPrevious() or wsOnNext()) methods and navigates to the given
     * step if the component does not abort or its state is invalid (for next navigation).
     *
     * @param {?} stepData The NgWizardStepData of the the step to navigate to
     * @return {?}
     */
    navigateToStep(stepData) {
        /** @type {?} */
        let goAhead;
        if (this.currentStepData.order > stepData.order) {
            goAhead = this.currentComponent.wsOnPrevious();
        }
        else {
            goAhead = this.currentComponent.wsIsValid() && this.currentComponent.wsOnNext();
        }
        if (goAhead === false) {
            return;
        }
        /** @type {?} */
        let stepPath = stepData.path;
        // If the wizard is added to a specific path in the application we have to join that path and
        // the step's path as the path to navigate to.
        // The Angular Router's relativeTo option does not seem to work when using the hash location
        // strategy.
        if (this.wizardRoute.path) {
            stepPath = [this.wizardRoute.path, stepData.path].join('/');
        }
        if (stepData.options.cleanQueryParameters) {
            return this.router.navigate([stepPath], { queryParams: {} });
        }
        else {
            return this.router.navigate([stepPath], { queryParamsHandling: 'merge' });
        }
        return this.router.navigate([stepPath], { queryParamsHandling: 'merge' });
    }
    /**
     * Utility method to navigate to the next step.
     * @return {?}
     */
    navigateToNextStep() {
        /** @type {?} */
        const nextStepData = utils.getStepDataForPath(this.stepData, this.currentStepData.nextStep);
        return this.navigateToStep(nextStepData);
    }
    /**
     * Utility method to navigate to the previous step.
     * @return {?}
     */
    navigateToPreviousStep() {
        /** @type {?} */
        const previousStepData = utils.getStepDataForPath(this.stepData, this.currentStepData.previousStep);
        return this.navigateToStep(previousStepData);
    }
    /**
     * Utility method to navigate to a specific route path (external to the wizard)
     * @param {?} path
     * @return {?}
     */
    navigateToPath(path) {
        return this.router.navigate([path], { queryParamsHandling: 'merge' });
    }
    /**
     * Returns the step data changes as an observable.
     * @return {?}
     */
    getStepDataChangesAsObservable() {
        return this.stepDataChanges.asObservable();
    }
    /**
     * Returns the current step data as an observable.
     * @return {?}
     */
    // TODO: Write a unit test for this method
    getCurrentStepDataAsObservable() {
        return this.getStepDataChangesAsObservable().pipe(map((/**
         * @param {?} stepDatas
         * @return {?}
         */
        (stepDatas) => stepDatas.find((/**
         * @param {?} stepData
         * @return {?}
         */
        (stepData) => stepData.isCurrent)))));
    }
    /**
     * Returns the Angular Route for the wizard component found in Angular's router config.
     * @private
     * @param {?} wizardComponentName The name of the wizard component
     * @return {?}
     */
    getWizardRoute(wizardComponentName) {
        return this.router.config.find((/**
         * @param {?} route
         * @return {?}
         */
        (route) => route.component && route.component.name === wizardComponentName));
    }
    /**
     * Parses the child routes of the wizard component route and stores them as a list of
     * NgWizardStepData.
     * @private
     * @param {?} wizardRoute The Angular Route for the wizard component
     * @return {?}
     */
    loadChildRoutes(wizardRoute) {
        if (!wizardRoute.children) {
            throw new NoChildRoutes(wizardRoute.component.name, wizardRoute.path);
        }
        /** @type {?} */
        const childRoutes = wizardRoute.children.filter((/**
         * @param {?} route
         * @return {?}
         */
        (route) => route.component));
        this.stepData = [];
        for (let i = 0; i < childRoutes.length; i++) {
            this.registerStep(i, childRoutes[i], childRoutes[i - 1], childRoutes[i + 1]);
        }
    }
    /**
     * Stores a child route as an NgWizardStepData.
     * @private
     * @param {?} index The index in the list of child routes
     * @param {?} stepRoute The child route
     * @param {?} previousStep The previous child route (undefined if first child route)
     * @param {?} nextStep The next child route (undefined if last child route)
     * @return {?}
     */
    registerStep(index, stepRoute, previousStep, nextStep) {
        this.stepData.push({
            order: index + 1,
            componentName: stepRoute.component.name,
            path: stepRoute.path,
            previousStep: previousStep ? previousStep.path : undefined,
            nextStep: nextStep ? nextStep.path : undefined,
            isCurrent: false,
            options: utils.getWizardStepOptions(stepRoute),
        });
        this.onStepDataChange();
    }
    /**
     * Emits a step data change event to the subscribers when the step data changes.
     * @private
     * @return {?}
     */
    onStepDataChange() {
        this.stepDataChanges.next(this.stepData);
    }
    /**
     * Sets the isCurrent attribute of all step data to false.
     * @private
     * @return {?}
     */
    resetCurrentStep() {
        this.stepData.map((/**
         * @param {?} stepData
         * @return {?}
         */
        (stepData) => {
            stepData.isCurrent = false;
            return stepData;
        }));
    }
}
NgWizardService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NgWizardService.ctorParameters = () => [
    { type: Router }
];
if (false) {
    /** @type {?} */
    NgWizardService.prototype.wizardOptions;
    /**
     * @type {?}
     * @private
     */
    NgWizardService.prototype.wizardRoute;
    /**
     * @type {?}
     * @private
     */
    NgWizardService.prototype.stepData;
    /**
     * @type {?}
     * @private
     */
    NgWizardService.prototype.currentStepData;
    /**
     * @type {?}
     * @private
     */
    NgWizardService.prototype.currentComponent;
    /**
     * @type {?}
     * @private
     */
    NgWizardService.prototype.stepDataChanges;
    /**
     * @type {?}
     * @private
     */
    NgWizardService.prototype.router;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctd2l6YXJkLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AY21kYXAvbmctd2l6YXJkLyIsInNvdXJjZXMiOlsibGliL25nLXdpemFyZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQWdCLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6RCxPQUFPLEVBQVMsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDaEQsT0FBTyxLQUFLLEtBQUssTUFBTSxtQkFBbUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsYUFBYSxFQUFFLGFBQWEsRUFBRSxhQUFhLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUdoRyxPQUFPLEVBQUUsZUFBZSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUlyQyxNQUFNLE9BQU8sZUFBZTs7OztJQVUxQixZQUFvQixNQUFjO1FBQWQsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQU4xQixhQUFRLEdBQXVCLEVBQUUsQ0FBQztRQUlsQyxvQkFBZSxHQUFHLElBQUksZUFBZSxDQUFxQixFQUFFLENBQUMsQ0FBQztJQUVqQyxDQUFDOzs7Ozs7O0lBTy9CLGdCQUFnQixDQUFDLG1CQUEyQjtRQUNqRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUM1RCxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNyQixNQUFNLElBQUksYUFBYSxDQUFDLG1CQUFtQixDQUFDLENBQUM7U0FDOUM7UUFDRCxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7Ozs7OztJQU1N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O0lBRXRDLHNDQUEyQjs7Ozs7SUFDM0IsbUNBQTBDOzs7OztJQUMxQywwQ0FBMEM7Ozs7O0lBQzFDLDJDQUF1Qzs7Ozs7SUFFdkMsMENBQXNFOzs7OztJQUUxRCxpQ0FBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRSZWYsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUm91dGUsIFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gJy4vbmctd2l6YXJkLnV0aWxzJztcclxuaW1wb3J0IHsgTm9DaGlsZFJvdXRlcywgTm9XaXphcmRSb3V0ZSwgTm9Xc0ludGVyZmFjZSB9IGZyb20gJy4vbmctd2l6YXJkLWVycm9yL25nLXdpemFyZC5lcnJvcic7XHJcbmltcG9ydCB7IE5nV2l6YXJkU3RlcERhdGEgfSBmcm9tICcuL25nLXdpemFyZC1zdGVwL25nLXdpemFyZC1zdGVwLWRhdGEuaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgTmdXaXphcmRTdGVwIH0gZnJvbSAnLi9uZy13aXphcmQtc3RlcC9uZy13aXphcmQtc3RlcCc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE5nV2l6YXJkT3B0aW9ucyB9IGZyb20gJy4vbmctd2l6YXJkLW9wdGlvbnMvbmctd2l6YXJkLW9wdGlvbnMuaW50ZXJmYWNlJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIE5nV2l6YXJkU2VydmljZSB7XHJcbiAgcHVibGljIHdpemFyZE9wdGlvbnM6IE5nV2l6YXJkT3B0aW9ucztcclxuXHJcbiAgcHJpdmF0ZSB3aXphcmRSb3V0ZTogUm91dGU7XHJcbiAgcHJpdmF0ZSBzdGVwRGF0YTogTmdXaXphcmRTdGVwRGF0YVtdID0gW107XHJcbiAgcHJpdmF0ZSBjdXJyZW50U3RlcERhdGE6IE5nV2l6YXJkU3RlcERhdGE7XHJcbiAgcHJpdmF0ZSBjdXJyZW50Q29tcG9uZW50OiBOZ1dpemFyZFN0ZXA7XHJcblxyXG4gIHByaXZhdGUgc3RlcERhdGFDaGFuZ2VzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxOZ1dpemFyZFN0ZXBEYXRhW10+KFtdKTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByb3V0ZXI6IFJvdXRlcikge31cclxuXHJcbiAgLyoqXHJcbiAgICogSW5pdGlhbGl6ZXMgdGhlIHdpemFyZCBieSBwYXJzaW5nIHRoZSB3aXphcmQncyBjaGlsZCByb3V0ZXMgZm91bmQgaW4gQW5ndWxhcidzIHJvdXRlciBjb25maWdcclxuICAgKiBpbnRvIGEgbGlzdCBvZiBOZ1dpemFyZFN0ZXBEYXRhLlxyXG4gICAqIEBwYXJhbSB3aXphcmRDb21wb25lbnROYW1lIFRoZSBuYW1lIG9mIHRoZSB3aXphcmQgY29tcG9uZW50XHJcbiAgICovXHJcbiAgcHVibGljIGxvYWRXaXphcmRSb3V0ZXMod2l6YXJkQ29tcG9uZW50TmFtZTogc3RyaW5nKSB7XHJcbiAgICB0aGlzLndpemFyZFJvdXRlID0gdGhpcy5nZXRXaXphcmRSb3V0ZSh3aXphcmRDb21wb25lbnROYW1lKTtcclxuICAgIGlmICghdGhpcy53aXphcmRSb3V0ZSkge1xyXG4gICAgICB0aHJvdyBuZXcgTm9XaXphcmRSb3V0ZSh3aXphcmRDb21wb25lbnROYW1lKTtcclxuICAgIH1cclxuICAgIHRoaXMud2l6YXJkT3B0aW9ucyA9IHV0aWxzLm1lcmdlV2l6YXJkT3B0aW9ucyh0aGlzLndpemFyZFJvdXRlLmRhdGEpO1xyXG4gICAgdGhpcy5sb2FkQ2hpbGRSb3V0ZXModGhpcy53aXphcmRSb3V0ZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDaGVja3MgYW5kIHN0b3JlcyB0aGUgY3VycmVudGx5IGRpc3BsYXllZCBjb21wb25lbnQuXHJcbiAgICogQHBhcmFtIGNvbXBvbmVudFJlZiBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IGRpc3BsYXllZCBjb21wb25lbnRcclxuICAgKi9cclxuICBwdWJsaWMgcmVnaXN0ZXJBY3RpdmVDb21wb25lbnQoY29tcG9uZW50UmVmOiBDb21wb25lbnRSZWY8YW55Pikge1xyXG4gICAgaWYgKCF1dGlscy5jb21wb25lbnRJbXBsZW1lbnRzTmdXaXphcmRTdGVwSW50ZXJmYWNlKGNvbXBvbmVudFJlZikpIHtcclxuICAgICAgdGhyb3cgbmV3IE5vV3NJbnRlcmZhY2UoY29tcG9uZW50UmVmLmNvbnN0cnVjdG9yLm5hbWUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENhc3QgdG8gdW5rbm93biBiZWZvcmUgY2FzdGluZyB0byBOZ1dpemFyZFN0ZXAgdG8gbGV0IHR5cGVzY3JpcHQga25vdyB3ZSBjaGVja2VkIGFuZCBhcHByb3ZlXHJcbiAgICAvLyB0aGlzIGNvbnZlcnNpb24uXHJcbiAgICB0aGlzLmN1cnJlbnRDb21wb25lbnQgPSAoY29tcG9uZW50UmVmIGFzIHVua25vd24pIGFzIE5nV2l6YXJkU3RlcDtcclxuICAgIHRoaXMuY3VycmVudFN0ZXBEYXRhID0gdXRpbHMuZ2V0U3RlcERhdGFGb3JVcmwodGhpcy5zdGVwRGF0YSwgdGhpcy5yb3V0ZXIudXJsKTtcclxuICAgIHRoaXMuY3VycmVudFN0ZXBEYXRhLmNvbXBvbmVudFJlZiA9IGNvbXBvbmVudFJlZjtcclxuICAgIHRoaXMucmVzZXRDdXJyZW50U3RlcCgpO1xyXG4gICAgdGhpcy5jdXJyZW50U3RlcERhdGEuaXNDdXJyZW50ID0gdHJ1ZTtcclxuICAgIHRoaXMub25TdGVwRGF0YUNoYW5nZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2FsbHMgdGhlIGN1cnJlbnQgY29tcG9uZW50J3Mgd3NPblByZXZpb3VzKCkgb3Igd3NPbk5leHQoKSkgbWV0aG9kcyBhbmQgbmF2aWdhdGVzIHRvIHRoZSBnaXZlblxyXG4gICAqIHN0ZXAgaWYgdGhlIGNvbXBvbmVudCBkb2VzIG5vdCBhYm9ydCBvciBpdHMgc3RhdGUgaXMgaW52YWxpZCAoZm9yIG5leHQgbmF2aWdhdGlvbikuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gc3RlcERhdGEgVGhlIE5nV2l6YXJkU3RlcERhdGEgb2YgdGhlIHRoZSBzdGVwIHRvIG5hdmlnYXRlIHRvXHJcbiAgICovXHJcbiAgcHVibGljIG5hdmlnYXRlVG9TdGVwKHN0ZXBEYXRhOiBOZ1dpemFyZFN0ZXBEYXRhKSB7XHJcbiAgICBsZXQgZ29BaGVhZDtcclxuICAgIGlmICh0aGlzLmN1cnJlbnRTdGVwRGF0YS5vcmRlciA+IHN0ZXBEYXRhLm9yZGVyKSB7XHJcbiAgICAgIGdvQWhlYWQgPSB0aGlzLmN1cnJlbnRDb21wb25lbnQud3NPblByZXZpb3VzKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBnb0FoZWFkID0gdGhpcy5jdXJyZW50Q29tcG9uZW50LndzSXNWYWxpZCgpICYmIHRoaXMuY3VycmVudENvbXBvbmVudC53c09uTmV4dCgpO1xyXG4gICAgfVxyXG4gICAgaWYgKGdvQWhlYWQgPT09IGZhbHNlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgc3RlcFBhdGggPSBzdGVwRGF0YS5wYXRoO1xyXG4gICAgLy8gSWYgdGhlIHdpemFyZCBpcyBhZGRlZCB0byBhIHNwZWNpZmljIHBhdGggaW4gdGhlIGFwcGxpY2F0aW9uIHdlIGhhdmUgdG8gam9pbiB0aGF0IHBhdGggYW5kXHJcbiAgICAvLyB0aGUgc3RlcCdzIHBhdGggYXMgdGhlIHBhdGggdG8gbmF2aWdhdGUgdG8uXHJcbiAgICAvLyBUaGUgQW5ndWxhciBSb3V0ZXIncyByZWxhdGl2ZVRvIG9wdGlvbiBkb2VzIG5vdCBzZWVtIHRvIHdvcmsgd2hlbiB1c2luZyB0aGUgaGFzaCBsb2NhdGlvblxyXG4gICAgLy8gc3RyYXRlZ3kuXHJcbiAgICBpZiAodGhpcy53aXphcmRSb3V0ZS5wYXRoKSB7XHJcbiAgICAgIHN0ZXBQYXRoID0gW3RoaXMud2l6YXJkUm91dGUucGF0aCwgc3RlcERhdGEucGF0aF0uam9pbignLycpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChzdGVwRGF0YS5vcHRpb25zLmNsZWFuUXVlcnlQYXJhbWV0ZXJzKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbc3RlcFBhdGhdLCB7IHF1ZXJ5UGFyYW1zOiB7fSB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbc3RlcFBhdGhdLCB7IHF1ZXJ5UGFyYW1zSGFuZGxpbmc6ICdtZXJnZScgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5yb3V0ZXIubmF2aWdhdGUoW3N0ZXBQYXRoXSwgeyBxdWVyeVBhcmFtc0hhbmRsaW5nOiAnbWVyZ2UnIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXRpbGl0eSBtZXRob2QgdG8gbmF2aWdhdGUgdG8gdGhlIG5leHQgc3RlcC5cclxuICAgKi9cclxuICBwdWJsaWMgbmF2aWdhdGVUb05leHRTdGVwKCkge1xyXG4gICAgY29uc3QgbmV4dFN0ZXBEYXRhID0gdXRpbHMuZ2V0U3RlcERhdGFGb3JQYXRoKHRoaXMuc3RlcERhdGEsIHRoaXMuY3VycmVudFN0ZXBEYXRhLm5leHRTdGVwKTtcclxuICAgIHJldHVybiB0aGlzLm5hdmlnYXRlVG9TdGVwKG5leHRTdGVwRGF0YSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBVdGlsaXR5IG1ldGhvZCB0byBuYXZpZ2F0ZSB0byB0aGUgcHJldmlvdXMgc3RlcC5cclxuICAgKi9cclxuICBwdWJsaWMgbmF2aWdhdGVUb1ByZXZpb3VzU3RlcCgpIHtcclxuICAgIGNvbnN0IHByZXZpb3VzU3RlcERhdGEgPSB1dGlscy5nZXRTdGVwRGF0YUZvclBhdGgodGhpcy5zdGVwRGF0YSwgdGhpcy5jdXJyZW50U3RlcERhdGEucHJldmlvdXNTdGVwKTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5uYXZpZ2F0ZVRvU3RlcChwcmV2aW91c1N0ZXBEYXRhKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFV0aWxpdHkgbWV0aG9kIHRvIG5hdmlnYXRlIHRvIGEgc3BlY2lmaWMgcm91dGUgcGF0aCAoZXh0ZXJuYWwgdG8gdGhlIHdpemFyZClcclxuICAgKi9cclxuICBwdWJsaWMgbmF2aWdhdGVUb1BhdGgocGF0aDogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gdGhpcy5yb3V0ZXIubmF2aWdhdGUoW3BhdGhdLCB7IHF1ZXJ5UGFyYW1zSGFuZGxpbmc6ICdtZXJnZScgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSBzdGVwIGRhdGEgY2hhbmdlcyBhcyBhbiBvYnNlcnZhYmxlLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRTdGVwRGF0YUNoYW5nZXNBc09ic2VydmFibGUoKTogT2JzZXJ2YWJsZTxOZ1dpemFyZFN0ZXBEYXRhW10+IHtcclxuICAgIHJldHVybiB0aGlzLnN0ZXBEYXRhQ2hhbmdlcy5hc09ic2VydmFibGUoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgdGhlIGN1cnJlbnQgc3RlcCBkYXRhIGFzIGFuIG9ic2VydmFibGUuXHJcbiAgICovXHJcbiAgLy8gVE9ETzogV3JpdGUgYSB1bml0IHRlc3QgZm9yIHRoaXMgbWV0aG9kXHJcbiAgcHVibGljIGdldEN1cnJlbnRTdGVwRGF0YUFzT2JzZXJ2YWJsZSgpOiBPYnNlcnZhYmxlPE5nV2l6YXJkU3RlcERhdGE+IHtcclxuICAgIHJldHVybiB0aGlzLmdldFN0ZXBEYXRhQ2hhbmdlc0FzT2JzZXJ2YWJsZSgpLnBpcGUoXHJcbiAgICAgIG1hcCgoc3RlcERhdGFzKSA9PiBzdGVwRGF0YXMuZmluZCgoc3RlcERhdGEpID0+IHN0ZXBEYXRhLmlzQ3VycmVudCkpLFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgdGhlIEFuZ3VsYXIgUm91dGUgZm9yIHRoZSB3aXphcmQgY29tcG9uZW50IGZvdW5kIGluIEFuZ3VsYXIncyByb3V0ZXIgY29uZmlnLlxyXG4gICAqIEBwYXJhbSB3aXphcmRDb21wb25lbnROYW1lIFRoZSBuYW1lIG9mIHRoZSB3aXphcmQgY29tcG9uZW50XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRXaXphcmRSb3V0ZSh3aXphcmRDb21wb25lbnROYW1lOiBzdHJpbmcpOiBSb3V0ZSB7XHJcbiAgICByZXR1cm4gdGhpcy5yb3V0ZXIuY29uZmlnLmZpbmQoKHJvdXRlKSA9PiByb3V0ZS5jb21wb25lbnQgJiYgcm91dGUuY29tcG9uZW50Lm5hbWUgPT09IHdpemFyZENvbXBvbmVudE5hbWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUGFyc2VzIHRoZSBjaGlsZCByb3V0ZXMgb2YgdGhlIHdpemFyZCBjb21wb25lbnQgcm91dGUgYW5kIHN0b3JlcyB0aGVtIGFzIGEgbGlzdCBvZlxyXG4gICAqIE5nV2l6YXJkU3RlcERhdGEuXHJcbiAgICogQHBhcmFtIHdpemFyZFJvdXRlIFRoZSBBbmd1bGFyIFJvdXRlIGZvciB0aGUgd2l6YXJkIGNvbXBvbmVudFxyXG4gICAqL1xyXG4gIHByaXZhdGUgbG9hZENoaWxkUm91dGVzKHdpemFyZFJvdXRlOiBSb3V0ZSkge1xyXG4gICAgaWYgKCF3aXphcmRSb3V0ZS5jaGlsZHJlbikge1xyXG4gICAgICB0aHJvdyBuZXcgTm9DaGlsZFJvdXRlcyh3aXphcmRSb3V0ZS5jb21wb25lbnQubmFtZSwgd2l6YXJkUm91dGUucGF0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY2hpbGRSb3V0ZXMgPSB3aXphcmRSb3V0ZS5jaGlsZHJlbi5maWx0ZXIoKHJvdXRlKSA9PiByb3V0ZS5jb21wb25lbnQpO1xyXG5cclxuICAgIHRoaXMuc3RlcERhdGEgPSBbXTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRSb3V0ZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgdGhpcy5yZWdpc3RlclN0ZXAoaSwgY2hpbGRSb3V0ZXNbaV0sIGNoaWxkUm91dGVzW2kgLSAxXSwgY2hpbGRSb3V0ZXNbaSArIDFdKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0b3JlcyBhIGNoaWxkIHJvdXRlIGFzIGFuIE5nV2l6YXJkU3RlcERhdGEuXHJcbiAgICogQHBhcmFtIGluZGV4IFRoZSBpbmRleCBpbiB0aGUgbGlzdCBvZiBjaGlsZCByb3V0ZXNcclxuICAgKiBAcGFyYW0gc3RlcFJvdXRlIFRoZSBjaGlsZCByb3V0ZVxyXG4gICAqIEBwYXJhbSBwcmV2aW91c1N0ZXAgVGhlIHByZXZpb3VzIGNoaWxkIHJvdXRlICh1bmRlZmluZWQgaWYgZmlyc3QgY2hpbGQgcm91dGUpXHJcbiAgICogQHBhcmFtIG5leHRTdGVwIFRoZSBuZXh0IGNoaWxkIHJvdXRlICh1bmRlZmluZWQgaWYgbGFzdCBjaGlsZCByb3V0ZSlcclxuICAgKi9cclxuICBwcml2YXRlIHJlZ2lzdGVyU3RlcChpbmRleDogbnVtYmVyLCBzdGVwUm91dGU6IFJvdXRlLCBwcmV2aW91c1N0ZXA6IFJvdXRlLCBuZXh0U3RlcDogUm91dGUpIHtcclxuICAgIHRoaXMuc3RlcERhdGEucHVzaCh7XHJcbiAgICAgIG9yZGVyOiBpbmRleCArIDEsXHJcbiAgICAgIGNvbXBvbmVudE5hbWU6IHN0ZXBSb3V0ZS5jb21wb25lbnQubmFtZSxcclxuICAgICAgcGF0aDogc3RlcFJvdXRlLnBhdGgsXHJcbiAgICAgIHByZXZpb3VzU3RlcDogcHJldmlvdXNTdGVwID8gcHJldmlvdXNTdGVwLnBhdGggOiB1bmRlZmluZWQsXHJcbiAgICAgIG5leHRTdGVwOiBuZXh0U3RlcCA/IG5leHRTdGVwLnBhdGggOiB1bmRlZmluZWQsXHJcbiAgICAgIGlzQ3VycmVudDogZmFsc2UsXHJcbiAgICAgIG9wdGlvbnM6IHV0aWxzLmdldFdpemFyZFN0ZXBPcHRpb25zKHN0ZXBSb3V0ZSksXHJcbiAgICB9KTtcclxuICAgIHRoaXMub25TdGVwRGF0YUNoYW5nZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRW1pdHMgYSBzdGVwIGRhdGEgY2hhbmdlIGV2ZW50IHRvIHRoZSBzdWJzY3JpYmVycyB3aGVuIHRoZSBzdGVwIGRhdGEgY2hhbmdlcy5cclxuICAgKi9cclxuICBwcml2YXRlIG9uU3RlcERhdGFDaGFuZ2UoKSB7XHJcbiAgICB0aGlzLnN0ZXBEYXRhQ2hhbmdlcy5uZXh0KHRoaXMuc3RlcERhdGEpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0cyB0aGUgaXNDdXJyZW50IGF0dHJpYnV0ZSBvZiBhbGwgc3RlcCBkYXRhIHRvIGZhbHNlLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVzZXRDdXJyZW50U3RlcCgpIHtcclxuICAgIHRoaXMuc3RlcERhdGEubWFwKChzdGVwRGF0YSkgPT4ge1xyXG4gICAgICBzdGVwRGF0YS5pc0N1cnJlbnQgPSBmYWxzZTtcclxuICAgICAgcmV0dXJuIHN0ZXBEYXRhO1xyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==