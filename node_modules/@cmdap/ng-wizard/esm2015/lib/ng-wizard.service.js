/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import * as utils from './ng-wizard.utils';
import { NoChildRoutes, NoWizardRoute, NoWsInterface } from './ng-wizard-error/ng-wizard.error';
import { BehaviorSubject } from 'rxjs';
import { map } from 'rxjs/operators';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/router';
export class NgWizardService {
    /**
     * @param {?} router
     */
    constructor(router) {
        this.router = router;
        this.stepData = [];
        this.stepDataChanges = new BehaviorSubject([]);
    }
    /**
     * Initializes the wizard by parsing the wizard's child routes found in Angular's router config
     * into a list of NgWizardStepData.
     * @param {?} wizardComponentName The name of the wizard component
     * @return {?}
     */
    loadWizardRoutes(wizardComponentName) {
        this.wizardRoute = this.getWizardRoute(wizardComponentName);
        if (!this.wizardRoute) {
            throw new NoWizardRoute(wizardComponentName);
        }
        this.wizardOptions = utils.mergeWizardOptions(this.wizardRoute.data);
        this.loadChildRoutes(this.wizardRoute);
    }
    /**
     * Checks and stores the currently displayed component.
     * @param {?} componentRef A reference to the currently displayed component
     * @return {?}
     */
    registerActiveComponent(componentRef) {
        if (!utils.componentImplementsNgWizardStepInterface(componentRef)) {
            throw new NoWsInterface(componentRef.constructor.name);
        }
        // Cast to unknown before casting to NgWizardStep to let typescript know we checked and approve
        // this conversion.
        this.currentComponent = (/** @type {?} */ (((/** @type {?} */ (componentRef)))));
        this.currentStepData = utils.getStepDataForUrl(this.stepData, this.router.url);
        this.currentStepData.componentRef = componentRef;
        this.resetCurrentStep();
        this.currentStepData.isCurrent = true;
        this.onStepDataChange();
    }
    /**
     * Calls the current component's wsOnPrevious() or wsOnNext()) methods and navigates to the given
     * step if the component does not abort or its state is invalid (for next navigation).
     *
     * @param {?} stepData The NgWizardStepData of the the step to navigate to
     * @return {?}
     */
    navigateToStep(stepData) {
        /** @type {?} */
        let goAhead;
        if (this.currentStepData.order > stepData.order) {
            goAhead = this.currentComponent.wsOnPrevious();
        }
        else {
            goAhead = this.currentComponent.wsIsValid() && this.currentComponent.wsOnNext();
        }
        if (goAhead === false) {
            return;
        }
        /** @type {?} */
        let stepPath = stepData.path;
        // If the wizard is added to a specific path in the application we have to join that path and
        // the step's path as the path to navigate to.
        // The Angular Router's relativeTo option does not seem to work when using the hash location
        // strategy.
        if (this.wizardRoute.path) {
            stepPath = [this.wizardRoute.path, stepData.path].join('/');
        }
        if (stepData.options.cleanQueryParameters) {
            return this.router.navigate([stepPath], { queryParams: {} });
        }
        else {
            return this.router.navigate([stepPath], { queryParamsHandling: 'merge' });
        }
        return this.router.navigate([stepPath], { queryParamsHandling: 'merge' });
    }
    /**
     * Utility method to navigate to the next step.
     * @return {?}
     */
    navigateToNextStep() {
        /** @type {?} */
        const nextStepData = utils.getStepDataForPath(this.stepData, this.currentStepData.nextStep);
        return this.navigateToStep(nextStepData);
    }
    /**
     * Utility method to navigate to the previous step.
     * @return {?}
     */
    navigateToPreviousStep() {
        /** @type {?} */
        const previousStepData = utils.getStepDataForPath(this.stepData, this.currentStepData.previousStep);
        return this.navigateToStep(previousStepData);
    }
    /**
     * Utility method to navigate to a specific route path (external to the wizard)
     * @param {?} path
     * @return {?}
     */
    navigateToPath(path) {
        return this.router.navigate([path], { queryParamsHandling: 'merge' });
    }
    /**
     * Returns the step data changes as an observable.
     * @return {?}
     */
    getStepDataChangesAsObservable() {
        return this.stepDataChanges.asObservable();
    }
    /**
     * Returns the current step data as an observable.
     * @return {?}
     */
    // TODO: Write a unit test for this method
    getCurrentStepDataAsObservable() {
        return this.getStepDataChangesAsObservable().pipe(map((/**
         * @param {?} stepDatas
         * @return {?}
         */
        (stepDatas) => stepDatas.find((/**
         * @param {?} stepData
         * @return {?}
         */
        (stepData) => stepData.isCurrent)))));
    }
    /**
     * Returns the Angular Route for the wizard component found in Angular's router config.
     * @private
     * @param {?} wizardComponentName The name of the wizard component
     * @return {?}
     */
    getWizardRoute(wizardComponentName) {
        return this.router.config.find((/**
         * @param {?} route
         * @return {?}
         */
        (route) => route.component && route.component.name === wizardComponentName));
    }
    /**
     * Parses the child routes of the wizard component route and stores them as a list of
     * NgWizardStepData.
     * @private
     * @param {?} wizardRoute The Angular Route for the wizard component
     * @return {?}
     */
    loadChildRoutes(wizardRoute) {
        if (!wizardRoute.children) {
            throw new NoChildRoutes(wizardRoute.component.name, wizardRoute.path);
        }
        /** @type {?} */
        const childRoutes = wizardRoute.children.filter((/**
         * @param {?} route
         * @return {?}
         */
        (route) => route.component));
        this.stepData = [];
        for (let i = 0; i < childRoutes.length; i++) {
            this.registerStep(i, childRoutes[i], childRoutes[i - 1], childRoutes[i + 1]);
        }
    }
    /**
     * Stores a child route as an NgWizardStepData.
     * @private
     * @param {?} index The index in the list of child routes
     * @param {?} stepRoute The child route
     * @param {?} previousStep The previous child route (undefined if first child route)
     * @param {?} nextStep The next child route (undefined if last child route)
     * @return {?}
     */
    registerStep(index, stepRoute, previousStep, nextStep) {
        this.stepData.push({
            order: index + 1,
            componentName: stepRoute.component.name,
            path: stepRoute.path,
            previousStep: previousStep ? previousStep.path : undefined,
            nextStep: nextStep ? nextStep.path : undefined,
            isCurrent: false,
            options: utils.getWizardStepOptions(stepRoute),
        });
        this.onStepDataChange();
    }
    /**
     * Emits a step data change event to the subscribers when the step data changes.
     * @private
     * @return {?}
     */
    onStepDataChange() {
        this.stepDataChanges.next(this.stepData);
    }
    /**
     * Sets the isCurrent attribute of all step data to false.
     * @private
     * @return {?}
     */
    resetCurrentStep() {
        this.stepData.map((/**
         * @param {?} stepData
         * @return {?}
         */
        (stepData) => {
            stepData.isCurrent = false;
            return stepData;
        }));
    }
}
NgWizardService.ɵfac = function NgWizardService_Factory(t) { return new (t || NgWizardService)(ɵngcc0.ɵɵinject(ɵngcc1.Router)); };
NgWizardService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: NgWizardService, factory: NgWizardService.ɵfac });
/** @nocollapse */
NgWizardService.ctorParameters = () => [
    { type: Router }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(NgWizardService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.Router }]; }, null); })();
if (false) {
    /** @type {?} */
    NgWizardService.prototype.wizardOptions;
    /**
     * @type {?}
     * @private
     */
    NgWizardService.prototype.wizardRoute;
    /**
     * @type {?}
     * @private
     */
    NgWizardService.prototype.stepData;
    /**
     * @type {?}
     * @private
     */
    NgWizardService.prototype.currentStepData;
    /**
     * @type {?}
     * @private
     */
    NgWizardService.prototype.currentComponent;
    /**
     * @type {?}
     * @private
     */
    NgWizardService.prototype.stepDataChanges;
    /**
     * @type {?}
     * @private
     */
    NgWizardService.prototype.router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctd2l6YXJkLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIm5nOi9AY21kYXAvbmctd2l6YXJkL2xpYi9uZy13aXphcmQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFnQixVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekQsT0FBTyxFQUFTLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2hELE9BQU8sS0FBSyxLQUFLLE1BQU0sbUJBQW1CLENBQUM7QUFDM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxhQUFhLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFHaEcsT0FBTyxFQUFFLGVBQWUsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUNuRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7OztBQUlyQyxNQUFNLE9BQU8sZUFBZTtBQUM1QjtBQUFRO0FBQXlCO0FBQ2pDLElBUUUsWUFBb0IsTUFBYztBQUFJLFFBQWxCLFdBQU0sR0FBTixNQUFNLENBQVE7QUFBQyxRQU4zQixhQUFRLEdBQXVCLEVBQUUsQ0FBQztBQUM1QyxRQUdVLG9CQUFlLEdBQUcsSUFBSSxlQUFlLENBQXFCLEVBQUUsQ0FBQyxDQUFDO0FBQ3hFLElBQ3VDLENBQUM7QUFDeEM7QUFFQztBQUNFO0FBQ0U7QUFFQTtBQUFtQjtBQUFRLElBQXZCLGdCQUFnQixDQUFDLG1CQUEyQjtBQUNyRCxRQUFJLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQ2hFLFFBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7QUFDM0IsWUFBTSxNQUFNLElBQUksYUFBYSxDQUFDLG1CQUFtQixDQUFDLENBQUM7QUFDbkQsU0FBSztBQUNMLFFBQUksSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJ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QSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQU1BLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQVFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFLQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFLQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFLQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUtBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBTUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBTUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFPQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUNBLEFBQUEsQUFTQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBS0EsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFLQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUF0TEEsQUFBQSxBQVRBLEFBQUEsQUFXQSxBQUFBLEFBRUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUVBLEFBQUEsQUFFQSxBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50UmVmLCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFJvdXRlLCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xyXG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tICcuL25nLXdpemFyZC51dGlscyc7XHJcbmltcG9ydCB7IE5vQ2hpbGRSb3V0ZXMsIE5vV2l6YXJkUm91dGUsIE5vV3NJbnRlcmZhY2UgfSBmcm9tICcuL25nLXdpemFyZC1lcnJvci9uZy13aXphcmQuZXJyb3InO1xyXG5pbXBvcnQgeyBOZ1dpemFyZFN0ZXBEYXRhIH0gZnJvbSAnLi9uZy13aXphcmQtc3RlcC9uZy13aXphcmQtc3RlcC1kYXRhLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IE5nV2l6YXJkU3RlcCB9IGZyb20gJy4vbmctd2l6YXJkLXN0ZXAvbmctd2l6YXJkLXN0ZXAnO1xyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBOZ1dpemFyZE9wdGlvbnMgfSBmcm9tICcuL25nLXdpemFyZC1vcHRpb25zL25nLXdpemFyZC1vcHRpb25zLmludGVyZmFjZSc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBOZ1dpemFyZFNlcnZpY2Uge1xyXG4gIHB1YmxpYyB3aXphcmRPcHRpb25zOiBOZ1dpemFyZE9wdGlvbnM7XHJcblxyXG4gIHByaXZhdGUgd2l6YXJkUm91dGU6IFJvdXRlO1xyXG4gIHByaXZhdGUgc3RlcERhdGE6IE5nV2l6YXJkU3RlcERhdGFbXSA9IFtdO1xyXG4gIHByaXZhdGUgY3VycmVudFN0ZXBEYXRhOiBOZ1dpemFyZFN0ZXBEYXRhO1xyXG4gIHByaXZhdGUgY3VycmVudENvbXBvbmVudDogTmdXaXphcmRTdGVwO1xyXG5cclxuICBwcml2YXRlIHN0ZXBEYXRhQ2hhbmdlcyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TmdXaXphcmRTdGVwRGF0YVtdPihbXSk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcm91dGVyOiBSb3V0ZXIpIHt9XHJcblxyXG4gIC8qKlxyXG4gICAqIEluaXRpYWxpemVzIHRoZSB3aXphcmQgYnkgcGFyc2luZyB0aGUgd2l6YXJkJ3MgY2hpbGQgcm91dGVzIGZvdW5kIGluIEFuZ3VsYXIncyByb3V0ZXIgY29uZmlnXHJcbiAgICogaW50byBhIGxpc3Qgb2YgTmdXaXphcmRTdGVwRGF0YS5cclxuICAgKiBAcGFyYW0gd2l6YXJkQ29tcG9uZW50TmFtZSBUaGUgbmFtZSBvZiB0aGUgd2l6YXJkIGNvbXBvbmVudFxyXG4gICAqL1xyXG4gIHB1YmxpYyBsb2FkV2l6YXJkUm91dGVzKHdpemFyZENvbXBvbmVudE5hbWU6IHN0cmluZykge1xyXG4gICAgdGhpcy53aXphcmRSb3V0ZSA9IHRoaXMuZ2V0V2l6YXJkUm91dGUod2l6YXJkQ29tcG9uZW50TmFtZSk7XHJcbiAgICBpZiAoIXRoaXMud2l6YXJkUm91dGUpIHtcclxuICAgICAgdGhyb3cgbmV3IE5vV2l6YXJkUm91dGUod2l6YXJkQ29tcG9uZW50TmFtZSk7XHJcbiAgICB9XHJcbiAgICB0aGlzLndpemFyZE9wdGlvbnMgPSB1dGlscy5tZXJnZVdpemFyZE9wdGlvbnModGhpcy53aXphcmRSb3V0ZS5kYXRhKTtcclxuICAgIHRoaXMubG9hZENoaWxkUm91dGVzKHRoaXMud2l6YXJkUm91dGUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2hlY2tzIGFuZCBzdG9yZXMgdGhlIGN1cnJlbnRseSBkaXNwbGF5ZWQgY29tcG9uZW50LlxyXG4gICAqIEBwYXJhbSBjb21wb25lbnRSZWYgQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBkaXNwbGF5ZWQgY29tcG9uZW50XHJcbiAgICovXHJcbiAgcHVibGljIHJlZ2lzdGVyQWN0aXZlQ29tcG9uZW50KGNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPGFueT4pIHtcclxuICAgIGlmICghdXRpbHMuY29tcG9uZW50SW1wbGVtZW50c05nV2l6YXJkU3RlcEludGVyZmFjZShjb21wb25lbnRSZWYpKSB7XHJcbiAgICAgIHRocm93IG5ldyBOb1dzSW50ZXJmYWNlKGNvbXBvbmVudFJlZi5jb25zdHJ1Y3Rvci5uYW1lKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBDYXN0IHRvIHVua25vd24gYmVmb3JlIGNhc3RpbmcgdG8gTmdXaXphcmRTdGVwIHRvIGxldCB0eXBlc2NyaXB0IGtub3cgd2UgY2hlY2tlZCBhbmQgYXBwcm92ZVxyXG4gICAgLy8gdGhpcyBjb252ZXJzaW9uLlxyXG4gICAgdGhpcy5jdXJyZW50Q29tcG9uZW50ID0gKGNvbXBvbmVudFJlZiBhcyB1bmtub3duKSBhcyBOZ1dpemFyZFN0ZXA7XHJcbiAgICB0aGlzLmN1cnJlbnRTdGVwRGF0YSA9IHV0aWxzLmdldFN0ZXBEYXRhRm9yVXJsKHRoaXMuc3RlcERhdGEsIHRoaXMucm91dGVyLnVybCk7XHJcbiAgICB0aGlzLmN1cnJlbnRTdGVwRGF0YS5jb21wb25lbnRSZWYgPSBjb21wb25lbnRSZWY7XHJcbiAgICB0aGlzLnJlc2V0Q3VycmVudFN0ZXAoKTtcclxuICAgIHRoaXMuY3VycmVudFN0ZXBEYXRhLmlzQ3VycmVudCA9IHRydWU7XHJcbiAgICB0aGlzLm9uU3RlcERhdGFDaGFuZ2UoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENhbGxzIHRoZSBjdXJyZW50IGNvbXBvbmVudCdzIHdzT25QcmV2aW91cygpIG9yIHdzT25OZXh0KCkpIG1ldGhvZHMgYW5kIG5hdmlnYXRlcyB0byB0aGUgZ2l2ZW5cclxuICAgKiBzdGVwIGlmIHRoZSBjb21wb25lbnQgZG9lcyBub3QgYWJvcnQgb3IgaXRzIHN0YXRlIGlzIGludmFsaWQgKGZvciBuZXh0IG5hdmlnYXRpb24pLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHN0ZXBEYXRhIFRoZSBOZ1dpemFyZFN0ZXBEYXRhIG9mIHRoZSB0aGUgc3RlcCB0byBuYXZpZ2F0ZSB0b1xyXG4gICAqL1xyXG4gIHB1YmxpYyBuYXZpZ2F0ZVRvU3RlcChzdGVwRGF0YTogTmdXaXphcmRTdGVwRGF0YSkge1xyXG4gICAgbGV0IGdvQWhlYWQ7XHJcbiAgICBpZiAodGhpcy5jdXJyZW50U3RlcERhdGEub3JkZXIgPiBzdGVwRGF0YS5vcmRlcikge1xyXG4gICAgICBnb0FoZWFkID0gdGhpcy5jdXJyZW50Q29tcG9uZW50LndzT25QcmV2aW91cygpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZ29BaGVhZCA9IHRoaXMuY3VycmVudENvbXBvbmVudC53c0lzVmFsaWQoKSAmJiB0aGlzLmN1cnJlbnRDb21wb25lbnQud3NPbk5leHQoKTtcclxuICAgIH1cclxuICAgIGlmIChnb0FoZWFkID09PSBmYWxzZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHN0ZXBQYXRoID0gc3RlcERhdGEucGF0aDtcclxuICAgIC8vIElmIHRoZSB3aXphcmQgaXMgYWRkZWQgdG8gYSBzcGVjaWZpYyBwYXRoIGluIHRoZSBhcHBsaWNhdGlvbiB3ZSBoYXZlIHRvIGpvaW4gdGhhdCBwYXRoIGFuZFxyXG4gICAgLy8gdGhlIHN0ZXAncyBwYXRoIGFzIHRoZSBwYXRoIHRvIG5hdmlnYXRlIHRvLlxyXG4gICAgLy8gVGhlIEFuZ3VsYXIgUm91dGVyJ3MgcmVsYXRpdmVUbyBvcHRpb24gZG9lcyBub3Qgc2VlbSB0byB3b3JrIHdoZW4gdXNpbmcgdGhlIGhhc2ggbG9jYXRpb25cclxuICAgIC8vIHN0cmF0ZWd5LlxyXG4gICAgaWYgKHRoaXMud2l6YXJkUm91dGUucGF0aCkge1xyXG4gICAgICBzdGVwUGF0aCA9IFt0aGlzLndpemFyZFJvdXRlLnBhdGgsIHN0ZXBEYXRhLnBhdGhdLmpvaW4oJy8nKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoc3RlcERhdGEub3B0aW9ucy5jbGVhblF1ZXJ5UGFyYW1ldGVycykge1xyXG4gICAgICByZXR1cm4gdGhpcy5yb3V0ZXIubmF2aWdhdGUoW3N0ZXBQYXRoXSwgeyBxdWVyeVBhcmFtczoge30gfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhpcy5yb3V0ZXIubmF2aWdhdGUoW3N0ZXBQYXRoXSwgeyBxdWVyeVBhcmFtc0hhbmRsaW5nOiAnbWVyZ2UnIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMucm91dGVyLm5hdmlnYXRlKFtzdGVwUGF0aF0sIHsgcXVlcnlQYXJhbXNIYW5kbGluZzogJ21lcmdlJyB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFV0aWxpdHkgbWV0aG9kIHRvIG5hdmlnYXRlIHRvIHRoZSBuZXh0IHN0ZXAuXHJcbiAgICovXHJcbiAgcHVibGljIG5hdmlnYXRlVG9OZXh0U3RlcCgpIHtcclxuICAgIGNvbnN0IG5leHRTdGVwRGF0YSA9IHV0aWxzLmdldFN0ZXBEYXRhRm9yUGF0aCh0aGlzLnN0ZXBEYXRhLCB0aGlzLmN1cnJlbnRTdGVwRGF0YS5uZXh0U3RlcCk7XHJcbiAgICByZXR1cm4gdGhpcy5uYXZpZ2F0ZVRvU3RlcChuZXh0U3RlcERhdGEpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXRpbGl0eSBtZXRob2QgdG8gbmF2aWdhdGUgdG8gdGhlIHByZXZpb3VzIHN0ZXAuXHJcbiAgICovXHJcbiAgcHVibGljIG5hdmlnYXRlVG9QcmV2aW91c1N0ZXAoKSB7XHJcbiAgICBjb25zdCBwcmV2aW91c1N0ZXBEYXRhID0gdXRpbHMuZ2V0U3RlcERhdGFGb3JQYXRoKHRoaXMuc3RlcERhdGEsIHRoaXMuY3VycmVudFN0ZXBEYXRhLnByZXZpb3VzU3RlcCk7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMubmF2aWdhdGVUb1N0ZXAocHJldmlvdXNTdGVwRGF0YSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBVdGlsaXR5IG1ldGhvZCB0byBuYXZpZ2F0ZSB0byBhIHNwZWNpZmljIHJvdXRlIHBhdGggKGV4dGVybmFsIHRvIHRoZSB3aXphcmQpXHJcbiAgICovXHJcbiAgcHVibGljIG5hdmlnYXRlVG9QYXRoKHBhdGg6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIHRoaXMucm91dGVyLm5hdmlnYXRlKFtwYXRoXSwgeyBxdWVyeVBhcmFtc0hhbmRsaW5nOiAnbWVyZ2UnIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyB0aGUgc3RlcCBkYXRhIGNoYW5nZXMgYXMgYW4gb2JzZXJ2YWJsZS5cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0U3RlcERhdGFDaGFuZ2VzQXNPYnNlcnZhYmxlKCk6IE9ic2VydmFibGU8TmdXaXphcmRTdGVwRGF0YVtdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5zdGVwRGF0YUNoYW5nZXMuYXNPYnNlcnZhYmxlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHN0ZXAgZGF0YSBhcyBhbiBvYnNlcnZhYmxlLlxyXG4gICAqL1xyXG4gIC8vIFRPRE86IFdyaXRlIGEgdW5pdCB0ZXN0IGZvciB0aGlzIG1ldGhvZFxyXG4gIHB1YmxpYyBnZXRDdXJyZW50U3RlcERhdGFBc09ic2VydmFibGUoKTogT2JzZXJ2YWJsZTxOZ1dpemFyZFN0ZXBEYXRhPiB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRTdGVwRGF0YUNoYW5nZXNBc09ic2VydmFibGUoKS5waXBlKFxyXG4gICAgICBtYXAoKHN0ZXBEYXRhcykgPT4gc3RlcERhdGFzLmZpbmQoKHN0ZXBEYXRhKSA9PiBzdGVwRGF0YS5pc0N1cnJlbnQpKSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSBBbmd1bGFyIFJvdXRlIGZvciB0aGUgd2l6YXJkIGNvbXBvbmVudCBmb3VuZCBpbiBBbmd1bGFyJ3Mgcm91dGVyIGNvbmZpZy5cclxuICAgKiBAcGFyYW0gd2l6YXJkQ29tcG9uZW50TmFtZSBUaGUgbmFtZSBvZiB0aGUgd2l6YXJkIGNvbXBvbmVudFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0V2l6YXJkUm91dGUod2l6YXJkQ29tcG9uZW50TmFtZTogc3RyaW5nKTogUm91dGUge1xyXG4gICAgcmV0dXJuIHRoaXMucm91dGVyLmNvbmZpZy5maW5kKChyb3V0ZSkgPT4gcm91dGUuY29tcG9uZW50ICYmIHJvdXRlLmNvbXBvbmVudC5uYW1lID09PSB3aXphcmRDb21wb25lbnROYW1lKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFBhcnNlcyB0aGUgY2hpbGQgcm91dGVzIG9mIHRoZSB3aXphcmQgY29tcG9uZW50IHJvdXRlIGFuZCBzdG9yZXMgdGhlbSBhcyBhIGxpc3Qgb2ZcclxuICAgKiBOZ1dpemFyZFN0ZXBEYXRhLlxyXG4gICAqIEBwYXJhbSB3aXphcmRSb3V0ZSBUaGUgQW5ndWxhciBSb3V0ZSBmb3IgdGhlIHdpemFyZCBjb21wb25lbnRcclxuICAgKi9cclxuICBwcml2YXRlIGxvYWRDaGlsZFJvdXRlcyh3aXphcmRSb3V0ZTogUm91dGUpIHtcclxuICAgIGlmICghd2l6YXJkUm91dGUuY2hpbGRyZW4pIHtcclxuICAgICAgdGhyb3cgbmV3IE5vQ2hpbGRSb3V0ZXMod2l6YXJkUm91dGUuY29tcG9uZW50Lm5hbWUsIHdpemFyZFJvdXRlLnBhdGgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNoaWxkUm91dGVzID0gd2l6YXJkUm91dGUuY2hpbGRyZW4uZmlsdGVyKChyb3V0ZSkgPT4gcm91dGUuY29tcG9uZW50KTtcclxuXHJcbiAgICB0aGlzLnN0ZXBEYXRhID0gW107XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkUm91dGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIHRoaXMucmVnaXN0ZXJTdGVwKGksIGNoaWxkUm91dGVzW2ldLCBjaGlsZFJvdXRlc1tpIC0gMV0sIGNoaWxkUm91dGVzW2kgKyAxXSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdG9yZXMgYSBjaGlsZCByb3V0ZSBhcyBhbiBOZ1dpemFyZFN0ZXBEYXRhLlxyXG4gICAqIEBwYXJhbSBpbmRleCBUaGUgaW5kZXggaW4gdGhlIGxpc3Qgb2YgY2hpbGQgcm91dGVzXHJcbiAgICogQHBhcmFtIHN0ZXBSb3V0ZSBUaGUgY2hpbGQgcm91dGVcclxuICAgKiBAcGFyYW0gcHJldmlvdXNTdGVwIFRoZSBwcmV2aW91cyBjaGlsZCByb3V0ZSAodW5kZWZpbmVkIGlmIGZpcnN0IGNoaWxkIHJvdXRlKVxyXG4gICAqIEBwYXJhbSBuZXh0U3RlcCBUaGUgbmV4dCBjaGlsZCByb3V0ZSAodW5kZWZpbmVkIGlmIGxhc3QgY2hpbGQgcm91dGUpXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZWdpc3RlclN0ZXAoaW5kZXg6IG51bWJlciwgc3RlcFJvdXRlOiBSb3V0ZSwgcHJldmlvdXNTdGVwOiBSb3V0ZSwgbmV4dFN0ZXA6IFJvdXRlKSB7XHJcbiAgICB0aGlzLnN0ZXBEYXRhLnB1c2goe1xyXG4gICAgICBvcmRlcjogaW5kZXggKyAxLFxyXG4gICAgICBjb21wb25lbnROYW1lOiBzdGVwUm91dGUuY29tcG9uZW50Lm5hbWUsXHJcbiAgICAgIHBhdGg6IHN0ZXBSb3V0ZS5wYXRoLFxyXG4gICAgICBwcmV2aW91c1N0ZXA6IHByZXZpb3VzU3RlcCA/IHByZXZpb3VzU3RlcC5wYXRoIDogdW5kZWZpbmVkLFxyXG4gICAgICBuZXh0U3RlcDogbmV4dFN0ZXAgPyBuZXh0U3RlcC5wYXRoIDogdW5kZWZpbmVkLFxyXG4gICAgICBpc0N1cnJlbnQ6IGZhbHNlLFxyXG4gICAgICBvcHRpb25zOiB1dGlscy5nZXRXaXphcmRTdGVwT3B0aW9ucyhzdGVwUm91dGUpLFxyXG4gICAgfSk7XHJcbiAgICB0aGlzLm9uU3RlcERhdGFDaGFuZ2UoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEVtaXRzIGEgc3RlcCBkYXRhIGNoYW5nZSBldmVudCB0byB0aGUgc3Vic2NyaWJlcnMgd2hlbiB0aGUgc3RlcCBkYXRhIGNoYW5nZXMuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBvblN0ZXBEYXRhQ2hhbmdlKCkge1xyXG4gICAgdGhpcy5zdGVwRGF0YUNoYW5nZXMubmV4dCh0aGlzLnN0ZXBEYXRhKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldHMgdGhlIGlzQ3VycmVudCBhdHRyaWJ1dGUgb2YgYWxsIHN0ZXAgZGF0YSB0byBmYWxzZS5cclxuICAgKi9cclxuICBwcml2YXRlIHJlc2V0Q3VycmVudFN0ZXAoKSB7XHJcbiAgICB0aGlzLnN0ZXBEYXRhLm1hcCgoc3RlcERhdGEpID0+IHtcclxuICAgICAgc3RlcERhdGEuaXNDdXJyZW50ID0gZmFsc2U7XHJcbiAgICAgIHJldHVybiBzdGVwRGF0YTtcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG4iXX0=