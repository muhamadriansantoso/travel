import * as tslib_1 from "tslib";
import { Component, Input, OnChanges, SimpleChanges, OnDestroy, Output, EventEmitter, OnInit, SimpleChange, ChangeDetectionStrategy, ViewEncapsulation, Inject, LOCALE_ID, ChangeDetectorRef, TemplateRef, NgZone, } from '@angular/core';
import { CountdownStatus } from './interfaces';
import { CountdownTimer } from './countdown.timer';
import { CountdownGlobalConfig } from './countdown.config';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/common';

function CountdownComponent_ng_container_0_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵelement(1, "span", 2);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    var ctx_r1152 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("innerHTML", ctx_r1152.i.text, ɵngcc0.ɵɵsanitizeHtml);
} }
function CountdownComponent_ng_container_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainer(0);
} }
var _c0 = function (a0) { return { $implicit: a0 }; };
var CountdownComponent = /** @class */ (function () {
    function CountdownComponent(locale, timer, defCog, cdr, ngZone) {
        this.locale = locale;
        this.timer = timer;
        this.defCog = defCog;
        this.cdr = cdr;
        this.ngZone = ngZone;
        this.frequency = 1000;
        this._notify = {};
        this._left = 0;
        this.status = CountdownStatus.ing;
        this.isDestroy = false;
        this.i = {};
        this.event = new EventEmitter();
    }
    Object.defineProperty(CountdownComponent.prototype, "left", {
        get: function () {
            return this._left;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Start countdown, you must manually call when `demand: false`
     */
    CountdownComponent.prototype.begin = function () {
        this.status = CountdownStatus.ing;
        this.callEvent('start');
    };
    /**
     * Restart countdown
     */
    CountdownComponent.prototype.restart = function () {
        if (this.status !== CountdownStatus.stop) {
            this.destroy();
        }
        this.init();
        this.callEvent('restart');
    };
    /**
     * Stop countdown, must call `restart` when stopped, it's different from pause, unable to recover
     */
    CountdownComponent.prototype.stop = function () {
        if (this.status === CountdownStatus.stop) {
            return;
        }
        this.status = CountdownStatus.stop;
        this.destroy();
        this.callEvent('stop');
    };
    /**
     * Pause countdown, you can use `resume` to recover again
     */
    CountdownComponent.prototype.pause = function () {
        if (this.status === CountdownStatus.stop || this.status === CountdownStatus.pause)
            return;
        this.status = CountdownStatus.pause;
        this.callEvent('pause');
    };
    /**
     * Resume countdown
     */
    CountdownComponent.prototype.resume = function () {
        if (this.status === CountdownStatus.stop || this.status !== CountdownStatus.pause)
            return;
        this.status = CountdownStatus.ing;
        this.callEvent('resume');
    };
    CountdownComponent.prototype.callEvent = function (action) {
        this.event.emit({ action: action, left: this._left, status: this.status, text: this.i.text });
    };
    CountdownComponent.prototype.init = function () {
        var _this = this;
        var _a = this, locale = _a.locale, defCog = _a.defCog;
        var config = (this.config = tslib_1.__assign({}, new CountdownGlobalConfig(locale), defCog, this.config));
        // tslint:disable-next-line: no-bitwise
        var frq = (this.frequency = ~config.format.indexOf('S') ? 100 : 1000);
        this.status = config.demand ? CountdownStatus.pause : CountdownStatus.ing;
        this.getLeft();
        // bind reflow to me
        var _reflow = this.reflow;
        this.reflow = function (count, force) {
            if (count === void 0) { count = 0; }
            if (force === void 0) { force = false; }
            return _reflow.apply(_this, [count, force]);
        };
        if (Array.isArray(config.notify)) {
            config.notify.forEach(function (time) {
                if (time < 1)
                    throw new Error("The notify config must be a positive integer.");
                time = time * 1000;
                time = time - (time % frq);
                _this._notify[time] = true;
            });
        }
        this.timer.add(this.reflow, frq).start();
        this.reflow(0, true);
    };
    CountdownComponent.prototype.destroy = function () {
        this.timer.remove(this.reflow);
        return this;
    };
    /**
     * 更新时钟
     */
    CountdownComponent.prototype.reflow = function (count, force) {
        var _this = this;
        if (count === void 0) { count = 0; }
        if (force === void 0) { force = false; }
        if (this.isDestroy)
            return;
        var _a = this, status = _a.status, config = _a.config, _notify = _a._notify;
        if (!force && status !== CountdownStatus.ing)
            return;
        var value = (this._left = this._left - this.frequency * count);
        this.i = {
            value: value,
            text: config.formatDate({ date: value, formatStr: config.format, timezone: config.timezone }),
        };
        if (typeof config.prettyText === 'function') {
            this.i.text = config.prettyText(this.i.text);
        }
        this.cdr.detectChanges();
        if (config.notify === 0 || _notify[value]) {
            this.ngZone.run(function () {
                _this.callEvent('notify');
            });
        }
        if (value < 1) {
            this.ngZone.run(function () {
                _this.status = CountdownStatus.done;
                _this.callEvent('done');
                _this.destroy();
            });
        }
    };
    /**
     * 获取倒计时剩余帧数
     */
    CountdownComponent.prototype.getLeft = function () {
        var _a = this, config = _a.config, frequency = _a.frequency;
        var left = config.leftTime * 1000;
        var end = config.stopTime;
        if (!left && end) {
            left = end - new Date().getTime();
        }
        this._left = left - (left % frequency);
    };
    CountdownComponent.prototype.ngOnInit = function () {
        this.init();
        if (!this.config.demand) {
            this.begin();
        }
    };
    CountdownComponent.prototype.ngOnDestroy = function () {
        this.isDestroy = true;
        this.destroy();
    };
    CountdownComponent.prototype.ngOnChanges = function (changes) {
        if (!changes.config.firstChange) {
            this.restart();
        }
    };
    CountdownComponent.ctorParameters = function () { return [
        { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
        { type: CountdownTimer },
        { type: CountdownGlobalConfig },
        { type: ChangeDetectorRef },
        { type: NgZone }
    ]; };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], CountdownComponent.prototype, "config", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", TemplateRef)
    ], CountdownComponent.prototype, "render", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], CountdownComponent.prototype, "event", void 0);
    CountdownComponent = tslib_1.__decorate([ tslib_1.__param(0, Inject(LOCALE_ID)),
        tslib_1.__metadata("design:paramtypes", [String, CountdownTimer,
            CountdownGlobalConfig,
            ChangeDetectorRef,
            NgZone])
    ], CountdownComponent);
CountdownComponent.ɵfac = function CountdownComponent_Factory(t) { return new (t || CountdownComponent)(ɵngcc0.ɵɵdirectiveInject(LOCALE_ID), ɵngcc0.ɵɵdirectiveInject(CountdownTimer), ɵngcc0.ɵɵdirectiveInject(CountdownGlobalConfig), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ChangeDetectorRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone)); };
CountdownComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: CountdownComponent, selectors: [["countdown"]], hostVars: 2, hostBindings: function CountdownComponent_HostBindings(rf, ctx) { if (rf & 2) {
        ɵngcc0.ɵɵclassProp("count-down", true);
    } }, inputs: { config: "config", render: "render" }, outputs: { event: "event" }, features: [ɵngcc0.ɵɵNgOnChangesFeature], decls: 2, vars: 5, consts: [[4, "ngIf"], [4, "ngTemplateOutlet", "ngTemplateOutletContext"], [3, "innerHTML"]], template: function CountdownComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵtemplate(0, CountdownComponent_ng_container_0_Template, 2, 1, "ng-container", 0);
        ɵngcc0.ɵɵtemplate(1, CountdownComponent_ng_container_1_Template, 1, 0, "ng-container", 1);
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("ngIf", !ctx.render);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngTemplateOutlet", ctx.render)("ngTemplateOutletContext", ɵngcc0.ɵɵpureFunction1(3, _c0, ctx.i));
    } }, directives: [ɵngcc1.NgIf, ɵngcc1.NgTemplateOutlet], encapsulation: 2, changeDetection: 0 });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(CountdownComponent, [{
        type: Component,
        args: [{
                selector: 'countdown',
                template: "\n    <ng-container *ngIf=\"!render\">\n      <span [innerHTML]=\"i.text\"></span>\n    </ng-container>\n    <ng-container *ngTemplateOutlet=\"render; context: { $implicit: i }\"></ng-container>\n  ",
                host: { '[class.count-down]': 'true' },
                encapsulation: ViewEncapsulation.None,
                changeDetection: ChangeDetectionStrategy.OnPush
            }]
    }], function () { return [{ type: String, decorators: [{
                type: Inject,
                args: [LOCALE_ID]
            }] }, { type: CountdownTimer }, { type: CountdownGlobalConfig }, { type: ɵngcc0.ChangeDetectorRef }, { type: ɵngcc0.NgZone }]; }, { event: [{
            type: Output
        }], config: [{
            type: Input
        }], render: [{
            type: Input
        }] }); })();
    return CountdownComponent;
}());
export { CountdownComponent };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY291bnRkb3duLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsibmc6L25neC1jb3VudGRvd24vY291bnRkb3duLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsU0FBUyxFQUNULGFBQWEsRUFDYixTQUFTLEVBQ1QsTUFBTSxFQUNOLFlBQVksRUFDWixNQUFNLEVBQ04sWUFBWSxFQUNaLHVCQUF1QixFQUN2QixpQkFBaUIsRUFDakIsTUFBTSxFQUNOLFNBQVMsRUFDVCxpQkFBaUIsRUFDakIsV0FBVyxFQUNYLE1BQU0sR0FDUCxNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQW1CLGVBQWUsRUFBdUQsTUFBTSxjQUFjLENBQUM7QUFDckgsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLG9CQUFvQixDQUFDOzs7Ozs7Ozs7Ozs7Ozs7OztBQWMzRDtBQUFzRCxJQVlwRCw0QkFDNkIsTUFBYyxFQUNqQyxLQUFxQixFQUNyQixNQUE2QixFQUM3QixHQUFzQixFQUN0QixNQUFjO0FBQ3hCLFFBTDZCLFdBQU0sR0FBTixNQUFNLENBQVE7QUFBQyxRQUNsQyxVQUFLLEdBQUwsS0FBSyxDQUFnQjtBQUFDLFFBQ3RCLFdBQU0sR0FBTixNQUFNLENBQXVCO0FBQUMsUUFDOUIsUUFBRyxHQUFILEdBQUcsQ0FBbUI7QUFBQyxRQUN2QixXQUFNLEdBQU4sTUFBTSxDQUFRO0FBQUMsUUFoQmpCLGNBQVMsR0FBRyxJQUFJLENBQUM7QUFDM0IsUUFBVSxZQUFPLEdBQVEsRUFBRSxDQUFDO0FBQzVCLFFBQVUsVUFBSyxHQUFHLENBQUMsQ0FBQztBQUNwQixRQUFVLFdBQU0sR0FBb0IsZUFBZSxDQUFDLEdBQUcsQ0FBQztBQUN4RCxRQUFVLGNBQVMsR0FBRyxLQUFLLENBQUM7QUFDNUIsUUFBRSxNQUFDLEdBQWtCLEVBQUUs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QUFLO0FBQ3BDLElBQVc7QUFBcUIsUUFBOUIsTUFBTSxFQUFFO0FBQUU7QUFBa0QscURBQUM7QUFFaEUsSUFaYSxrQkFBa0IsZ0NBWjlCLFNBQVMsQ0FBQyxjQUNULGpDQVdNLENBYUgsbUJBQUEsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFBO0NBeEJaLEVBQUUsV0FBVyxjQUNyQixRQUFRLEVBQUUsdENBdUJZLHlEQUNMLGNBQWM7QUFDakMsWUFBb0IscUJBQXFCO0FBQ3pDLFlBQWlCLGlCQUFpQjtBQUNsQyxZQUFvQixNQUFNO0FBQ3pCLE9BbEJZLGtCQUFrQixDQW9MOUI7a0RBekxFLGNBQ0QsSUFBSSxFQUFFLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLGNBQ3RDLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJLGNBQ3JDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNLFVBQ2hELENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQXNMRjtBQUFDLElBREQseUJBQUM7QUFDQSxDQURBLEFBcExELElBb0xDO0FBQ0QsU0FyTGEsa0JBQWtCO0FBQUkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIElucHV0LFxuICBPbkNoYW5nZXMsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgT3V0cHV0LFxuICBFdmVudEVtaXR0ZXIsXG4gIE9uSW5pdCxcbiAgU2ltcGxlQ2hhbmdlLFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgVmlld0VuY2Fwc3VsYXRpb24sXG4gIEluamVjdCxcbiAgTE9DQUxFX0lELFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgVGVtcGxhdGVSZWYsXG4gIE5nWm9uZSxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IENvdW50ZG93bkNvbmZpZywgQ291bnRkb3duU3RhdHVzLCBDb3VudGRvd25FdmVudCwgQ291bnRkb3duRXZlbnRBY3Rpb24sIENvdW50ZG93bkl0ZW0gfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgQ291bnRkb3duVGltZXIgfSBmcm9tICcuL2NvdW50ZG93bi50aW1lcic7XG5pbXBvcnQgeyBDb3VudGRvd25HbG9iYWxDb25maWcgfSBmcm9tICcuL2NvdW50ZG93bi5jb25maWcnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjb3VudGRvd24nLFxuICB0ZW1wbGF0ZTogYFxuICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCIhcmVuZGVyXCI+XG4gICAgICA8c3BhbiBbaW5uZXJIVE1MXT1cImkudGV4dFwiPjwvc3Bhbj5cbiAgICA8L25nLWNvbnRhaW5lcj5cbiAgICA8bmctY29udGFpbmVyICpuZ1RlbXBsYXRlT3V0bGV0PVwicmVuZGVyOyBjb250ZXh0OiB7ICRpbXBsaWNpdDogaSB9XCI+PC9uZy1jb250YWluZXI+XG4gIGAsXG4gIGhvc3Q6IHsgJ1tjbGFzcy5jb3VudC1kb3duXSc6ICd0cnVlJyB9LFxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbn0pXG5leHBvcnQgY2xhc3MgQ291bnRkb3duQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgZnJlcXVlbmN5ID0gMTAwMDtcbiAgcHJpdmF0ZSBfbm90aWZ5OiBhbnkgPSB7fTtcbiAgcHJpdmF0ZSBfbGVmdCA9IDA7XG4gIHByaXZhdGUgc3RhdHVzOiBDb3VudGRvd25TdGF0dXMgPSBDb3VudGRvd25TdGF0dXMuaW5nO1xuICBwcml2YXRlIGlzRGVzdHJveSA9IGZhbHNlO1xuICBpOiBDb3VudGRvd25JdGVtID0ge307XG5cbiAgQElucHV0KCkgY29uZmlnOiBDb3VudGRvd25Db25maWc7XG4gIEBJbnB1dCgpIHJlbmRlcjogVGVtcGxhdGVSZWY8dm9pZD47XG4gIEBPdXRwdXQoKSByZWFkb25seSBldmVudCA9IG5ldyBFdmVudEVtaXR0ZXI8Q291bnRkb3duRXZlbnQ+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChMT0NBTEVfSUQpIHByaXZhdGUgbG9jYWxlOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSB0aW1lcjogQ291bnRkb3duVGltZXIsXG4gICAgcHJpdmF0ZSBkZWZDb2c6IENvdW50ZG93bkdsb2JhbENvbmZpZyxcbiAgICBwcml2YXRlIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSxcbiAgKSB7fVxuXG4gIGdldCBsZWZ0KCkge1xuICAgIHJldHVybiB0aGlzLl9sZWZ0O1xuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0IGNvdW50ZG93biwgeW91IG11c3QgbWFudWFsbHkgY2FsbCB3aGVuIGBkZW1hbmQ6IGZhbHNlYFxuICAgKi9cbiAgYmVnaW4oKSB7XG4gICAgdGhpcy5zdGF0dXMgPSBDb3VudGRvd25TdGF0dXMuaW5nO1xuICAgIHRoaXMuY2FsbEV2ZW50KCdzdGFydCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc3RhcnQgY291bnRkb3duXG4gICAqL1xuICByZXN0YXJ0KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnN0YXR1cyAhPT0gQ291bnRkb3duU3RhdHVzLnN0b3ApIHtcbiAgICAgIHRoaXMuZGVzdHJveSgpO1xuICAgIH1cbiAgICB0aGlzLmluaXQoKTtcbiAgICB0aGlzLmNhbGxFdmVudCgncmVzdGFydCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0b3AgY291bnRkb3duLCBtdXN0IGNhbGwgYHJlc3RhcnRgIHdoZW4gc3RvcHBlZCwgaXQncyBkaWZmZXJlbnQgZnJvbSBwYXVzZSwgdW5hYmxlIHRvIHJlY292ZXJcbiAgICovXG4gIHN0b3AoKSB7XG4gICAgaWYgKHRoaXMuc3RhdHVzID09PSBDb3VudGRvd25TdGF0dXMuc3RvcCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnN0YXR1cyA9IENvdW50ZG93blN0YXR1cy5zdG9wO1xuICAgIHRoaXMuZGVzdHJveSgpO1xuICAgIHRoaXMuY2FsbEV2ZW50KCdzdG9wJyk7XG4gIH1cblxuICAvKipcbiAgICogUGF1c2UgY291bnRkb3duLCB5b3UgY2FuIHVzZSBgcmVzdW1lYCB0byByZWNvdmVyIGFnYWluXG4gICAqL1xuICBwYXVzZSgpIHtcbiAgICBpZiAodGhpcy5zdGF0dXMgPT09IENvdW50ZG93blN0YXR1cy5zdG9wIHx8IHRoaXMuc3RhdHVzID09PSBDb3VudGRvd25TdGF0dXMucGF1c2UpIHJldHVybjtcbiAgICB0aGlzLnN0YXR1cyA9IENvdW50ZG93blN0YXR1cy5wYXVzZTtcbiAgICB0aGlzLmNhbGxFdmVudCgncGF1c2UnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXN1bWUgY291bnRkb3duXG4gICAqL1xuICByZXN1bWUoKSB7XG4gICAgaWYgKHRoaXMuc3RhdHVzID09PSBDb3VudGRvd25TdGF0dXMuc3RvcCB8fCB0aGlzLnN0YXR1cyAhPT0gQ291bnRkb3duU3RhdHVzLnBhdXNlKSByZXR1cm47XG4gICAgdGhpcy5zdGF0dXMgPSBDb3VudGRvd25TdGF0dXMuaW5nO1xuICAgIHRoaXMuY2FsbEV2ZW50KCdyZXN1bWUnKTtcbiAgfVxuXG4gIHByaXZhdGUgY2FsbEV2ZW50KGFjdGlvbjogQ291bnRkb3duRXZlbnRBY3Rpb24pIHtcbiAgICB0aGlzLmV2ZW50LmVtaXQoeyBhY3Rpb24sIGxlZnQ6IHRoaXMuX2xlZnQsIHN0YXR1czogdGhpcy5zdGF0dXMsIHRleHQ6IHRoaXMuaS50ZXh0IH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0KCkge1xuICAgIGNvbnN0IHsgbG9jYWxlLCBkZWZDb2cgfSA9IHRoaXM7XG4gICAgY29uc3QgY29uZmlnID0gKHRoaXMuY29uZmlnID0ge1xuICAgICAgLi4ubmV3IENvdW50ZG93bkdsb2JhbENvbmZpZyhsb2NhbGUpLFxuICAgICAgLi4uZGVmQ29nLFxuICAgICAgLi4udGhpcy5jb25maWcsXG4gICAgfSk7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1iaXR3aXNlXG4gICAgY29uc3QgZnJxID0gKHRoaXMuZnJlcXVlbmN5ID0gfmNvbmZpZy5mb3JtYXQuaW5kZXhPZignUycpID8gMTAwIDogMTAwMCk7XG4gICAgdGhpcy5zdGF0dXMgPSBjb25maWcuZGVtYW5kID8gQ291bnRkb3duU3RhdHVzLnBhdXNlIDogQ291bnRkb3duU3RhdHVzLmluZztcblxuICAgIHRoaXMuZ2V0TGVmdCgpO1xuXG4gICAgLy8gYmluZCByZWZsb3cgdG8gbWVcbiAgICBjb25zdCBfcmVmbG93ID0gdGhpcy5yZWZsb3c7XG4gICAgdGhpcy5yZWZsb3cgPSAoY291bnQ6IG51bWJlciA9IDAsIGZvcmNlOiBib29sZWFuID0gZmFsc2UpID0+IF9yZWZsb3cuYXBwbHkodGhpcywgW2NvdW50LCBmb3JjZV0pO1xuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoY29uZmlnLm5vdGlmeSkpIHtcbiAgICAgIGNvbmZpZy5ub3RpZnkuZm9yRWFjaCgodGltZTogbnVtYmVyKSA9PiB7XG4gICAgICAgIGlmICh0aW1lIDwgMSkgdGhyb3cgbmV3IEVycm9yKGBUaGUgbm90aWZ5IGNvbmZpZyBtdXN0IGJlIGEgcG9zaXRpdmUgaW50ZWdlci5gKTtcblxuICAgICAgICB0aW1lID0gdGltZSAqIDEwMDA7XG4gICAgICAgIHRpbWUgPSB0aW1lIC0gKHRpbWUgJSBmcnEpO1xuICAgICAgICB0aGlzLl9ub3RpZnlbdGltZV0gPSB0cnVlO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgdGhpcy50aW1lci5hZGQodGhpcy5yZWZsb3csIGZycSkuc3RhcnQoKTtcblxuICAgIHRoaXMucmVmbG93KDAsIHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95KCkge1xuICAgIHRoaXMudGltZXIucmVtb3ZlKHRoaXMucmVmbG93KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiDmm7TmlrDml7bpkp9cbiAgICovXG4gIHByaXZhdGUgcmVmbG93KGNvdW50OiBudW1iZXIgPSAwLCBmb3JjZTogYm9vbGVhbiA9IGZhbHNlKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNEZXN0cm95KSByZXR1cm47XG5cbiAgICBjb25zdCB7IHN0YXR1cywgY29uZmlnLCBfbm90aWZ5IH0gPSB0aGlzO1xuICAgIGlmICghZm9yY2UgJiYgc3RhdHVzICE9PSBDb3VudGRvd25TdGF0dXMuaW5nKSByZXR1cm47XG5cbiAgICBjb25zdCB2YWx1ZSA9ICh0aGlzLl9sZWZ0ID0gdGhpcy5fbGVmdCAtIHRoaXMuZnJlcXVlbmN5ICogY291bnQpO1xuICAgIHRoaXMuaSA9IHtcbiAgICAgIHZhbHVlLFxuICAgICAgdGV4dDogY29uZmlnLmZvcm1hdERhdGUoeyBkYXRlOiB2YWx1ZSwgZm9ybWF0U3RyOiBjb25maWcuZm9ybWF0LCB0aW1lem9uZTogY29uZmlnLnRpbWV6b25lIH0pLFxuICAgIH07XG4gICAgaWYgKHR5cGVvZiBjb25maWcucHJldHR5VGV4dCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5pLnRleHQgPSBjb25maWcucHJldHR5VGV4dCh0aGlzLmkudGV4dCk7XG4gICAgfVxuICAgIHRoaXMuY2RyLmRldGVjdENoYW5nZXMoKTtcblxuICAgIGlmIChjb25maWcubm90aWZ5ID09PSAwIHx8IF9ub3RpZnlbdmFsdWVdKSB7XG4gICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICB0aGlzLmNhbGxFdmVudCgnbm90aWZ5Jyk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAodmFsdWUgPCAxKSB7XG4gICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICB0aGlzLnN0YXR1cyA9IENvdW50ZG93blN0YXR1cy5kb25lO1xuICAgICAgICB0aGlzLmNhbGxFdmVudCgnZG9uZScpO1xuICAgICAgICB0aGlzLmRlc3Ryb3koKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5blgJLorqHml7bliankvZnluKfmlbBcbiAgICovXG4gIHByaXZhdGUgZ2V0TGVmdCgpOiB2b2lkIHtcbiAgICBjb25zdCB7IGNvbmZpZywgZnJlcXVlbmN5IH0gPSB0aGlzO1xuICAgIGxldCBsZWZ0ID0gY29uZmlnLmxlZnRUaW1lICogMTAwMDtcbiAgICBjb25zdCBlbmQgPSBjb25maWcuc3RvcFRpbWU7XG5cbiAgICBpZiAoIWxlZnQgJiYgZW5kKSB7XG4gICAgICBsZWZ0ID0gZW5kIC0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgfVxuXG4gICAgdGhpcy5fbGVmdCA9IGxlZnQgLSAobGVmdCAlIGZyZXF1ZW5jeSk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmluaXQoKTtcbiAgICBpZiAoIXRoaXMuY29uZmlnLmRlbWFuZCkge1xuICAgICAgdGhpcy5iZWdpbigpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuaXNEZXN0cm95ID0gdHJ1ZTtcbiAgICB0aGlzLmRlc3Ryb3koKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IHsgW1AgaW4ga2V5b2YgdGhpc10/OiBTaW1wbGVDaGFuZ2UgfSAmIFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoIWNoYW5nZXMuY29uZmlnLmZpcnN0Q2hhbmdlKSB7XG4gICAgICB0aGlzLnJlc3RhcnQoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==